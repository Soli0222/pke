---
- name: Extract major.minor version from crio_version
  set_fact:
    crio_major_minor: "{{ crio_version | regex_replace('^v?([0-9]+\\.[0-9]+).*', '\\1') }}"

- name: Add CRI-O repository key
  shell:
    cmd: > 
      curl -fsSL https://pkgs.k8s.io/addons:/cri-o:/stable:/v{{ crio_major_minor }}/deb/Release.key |
      gpg --yes --dearmor -o /etc/apt/keyrings/cri-o-apt-keyring.gpg

- name: Add CRI-O repository
  shell:
    cmd: > 
      echo 'deb [signed-by=/etc/apt/keyrings/cri-o-apt-keyring.gpg] https://pkgs.k8s.io/addons:/cri-o:/stable:/v{{ crio_major_minor }}/deb/ /' |
      tee /etc/apt/sources.list.d/cri-o.list

- name: Hold cri-o package after upgrade
  dpkg_selections:
    name: cri-o
    selection: hold

- name: Unhold kubeadm package for upgrade
  dpkg_selections:
    name: kubeadm
    selection: install

- name: Install CRI-O
  apt:
    name: cri-o={{ crio_version }}-1.1
    state: present
    update_cache: yes

- name: Hold cri-o package after installation
  dpkg_selections:
    name: cri-o
    selection: hold
    
- name: Configure CRI-O runtime settings in /etc/crio/crio.conf
  template:
    src: crio.conf.j2
    dest: /etc/crio/crio.conf

- name: Restart CRI-O service
  systemd:
    name: crio
    state: restarted
    enabled: yes
    daemon_reload: yes