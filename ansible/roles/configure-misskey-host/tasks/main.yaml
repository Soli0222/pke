- name: Set hostname
  become: true
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Set timezone to JST
  become: true
  community.general.timezone:
    name: Asia/Tokyo

- name: Configure private network interface with Netplan
  become: true
  ansible.builtin.template:
    src: 50-private-network.yaml.j2
    dest: /etc/netplan/50-private-network.yaml
    owner: root
    group: root
    mode: '0644'

- name: Apply netplan configuration
  become: true
  ansible.builtin.command: netplan apply
  changed_when: false

- name: Install UFW
  become: true
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: true

- name: Set UFW default policies
  become: true
  community.general.ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: 'incoming', policy: 'deny' }
    - { direction: 'outgoing', policy: 'allow' }

- name: Allow all traffic on private interface
  become: true
  community.general.ufw:
    rule: allow
    interface: "{{ network.private.interface }}"
    direction: in

- name: Allow HTTP from Cloudflare IPv4 ranges on global interface
  become: true
  community.general.ufw:
    rule: allow
    interface: "{{ network.global.interface }}"
    direction: in
    proto: tcp
    port: '80'
    from_ip: "{{ item }}"
  loop:
    - 173.245.48.0/20
    - 103.21.244.0/22
    - 103.22.200.0/22
    - 103.31.4.0/22
    - 141.101.64.0/18
    - 108.162.192.0/18
    - 190.93.240.0/20
    - 188.114.96.0/20
    - 197.234.240.0/22
    - 198.41.128.0/17
    - 162.158.0.0/15
    - 104.16.0.0/13
    - 104.24.0.0/14
    - 172.64.0.0/13
    - 131.0.72.0/22

- name: Allow HTTPS from Cloudflare IPv4 ranges on global interface
  become: true
  community.general.ufw:
    rule: allow
    interface: "{{ network.global.interface }}"
    direction: in
    proto: tcp
    port: '443'
    from_ip: "{{ item }}"
  loop:
    - 173.245.48.0/20
    - 103.21.244.0/22
    - 103.22.200.0/22
    - 103.31.4.0/22
    - 141.101.64.0/18
    - 108.162.192.0/18
    - 190.93.240.0/20
    - 188.114.96.0/20
    - 197.234.240.0/22
    - 198.41.128.0/17
    - 162.158.0.0/15
    - 104.16.0.0/13
    - 104.24.0.0/14
    - 172.64.0.0/13
    - 131.0.72.0/22

- name: Allow HTTP from Cloudflare IPv6 ranges on global interface
  become: true
  community.general.ufw:
    rule: allow
    interface: "{{ network.global.interface }}"
    direction: in
    proto: tcp
    port: '80'
    from_ip: "{{ item }}"
  loop:
    - 2400:cb00::/32
    - 2606:4700::/32
    - 2803:f800::/32
    - 2405:b500::/32
    - 2405:8100::/32
    - 2a06:98c0::/29
    - 2c0f:f248::/32

- name: Allow HTTPS from Cloudflare IPv6 ranges on global interface
  become: true
  community.general.ufw:
    rule: allow
    interface: "{{ network.global.interface }}"
    direction: in
    proto: tcp
    port: '443'
    from_ip: "{{ item }}"
  loop:
    - 2400:cb00::/32
    - 2606:4700::/32
    - 2803:f800::/32
    - 2405:b500::/32
    - 2405:8100::/32
    - 2a06:98c0::/29
    - 2c0f:f248::/32

- name: Enable UFW
  become: true
  community.general.ufw:
    state: enabled

