- name: Set hostname
  become: true
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Set timezone to JST
  become: true
  community.general.timezone:
    name: Asia/Tokyo

- name: Configure private network interface with Netplan
  become: true
  ansible.builtin.template:
    src: 50-private-network.yaml.j2
    dest: /etc/netplan/50-private-network.yaml
    owner: root
    group: root
    mode: '0644'

- name: Apply netplan configuration
  become: true
  ansible.builtin.command: netplan apply
  changed_when: false

- name: Install UFW and Cron
  become: true
  ansible.builtin.apt:
    name: 
     - ufw
     - cron
    state: present
    update_cache: true

- name: Set UFW default policies
  become: true
  community.general.ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: 'incoming', policy: 'deny' }
    - { direction: 'outgoing', policy: 'allow' }

- name: Allow all traffic on private interface
  become: true
  community.general.ufw:
    rule: allow
    interface: "{{ network.private.interface }}"
    direction: in

- name: Fetch Cloudflare IPv4 ranges
  ansible.builtin.uri:
    url: https://www.cloudflare.com/ips-v4/
    return_content: true
  register: cloudflare_ipv4_response
  delegate_to: localhost
  run_once: true
  check_mode: false
  become: false

- name: Fetch Cloudflare IPv6 ranges
  ansible.builtin.uri:
    url: https://www.cloudflare.com/ips-v6/
    return_content: true
  register: cloudflare_ipv6_response
  delegate_to: localhost
  run_once: true
  check_mode: false
  become: false

- name: Set Cloudflare IP ranges facts
  ansible.builtin.set_fact:
    cloudflare_ipv4_ranges: "{{ cloudflare_ipv4_response.content.split('\n') | select('match', '^[0-9]') | list }}"
    cloudflare_ipv6_ranges: "{{ cloudflare_ipv6_response.content.split('\n') | select('match', '^[0-9a-fA-F]') | list }}"

- name: Allow HTTP from Cloudflare IPv4 ranges on global interface
  become: true
  community.general.ufw:
    rule: allow
    interface: "{{ network.global.interface }}"
    direction: in
    proto: tcp
    port: '80'
    from_ip: "{{ item }}"
  loop: "{{ cloudflare_ipv4_ranges }}"

- name: Allow HTTPS from Cloudflare IPv4 ranges on global interface
  become: true
  community.general.ufw:
    rule: allow
    interface: "{{ network.global.interface }}"
    direction: in
    proto: tcp
    port: '443'
    from_ip: "{{ item }}"
  loop: "{{ cloudflare_ipv4_ranges }}"

- name: Allow HTTP from Cloudflare IPv6 ranges on global interface
  become: true
  community.general.ufw:
    rule: allow
    interface: "{{ network.global.interface }}"
    direction: in
    proto: tcp
    port: '80'
    from_ip: "{{ item }}"
  loop: "{{ cloudflare_ipv6_ranges }}"

- name: Allow HTTPS from Cloudflare IPv6 ranges on global interface
  become: true
  community.general.ufw:
    rule: allow
    interface: "{{ network.global.interface }}"
    direction: in
    proto: tcp
    port: '443'
    from_ip: "{{ item }}"
  loop: "{{ cloudflare_ipv6_ranges }}"

- name: Enable UFW
  become: true
  community.general.ufw:
    state: enabled

- name: Full upgrade the system
  apt:
    upgrade: full
    update_cache: yes
    autoremove: yes

- name: Reboot the server after upgrade
  reboot:
    msg: "Reboot initiated by Ansible after full upgrade"
    connect_timeout: 5
    reboot_timeout: 600
    pre_reboot_delay: 10
    post_reboot_delay: 30