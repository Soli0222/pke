---
- name: Install Alloy
  ansible.builtin.include_role:
    name: grafana.grafana.alloy
  vars:
    alloy_config: "{{ lookup('template', 'alloy.alloy.j2') }}"

- name: Disable Alloy data collection
  ansible.builtin.lineinfile:
    path: /etc/default/alloy
    regexp: "^CUSTOM_ARGS="
    line: 'CUSTOM_ARGS="--disable-reporting"'
  when: alloy_disable_reporting | default(false)

- name: Restart Alloy
  ansible.builtin.systemd:
    name: alloy
    state: restarted
    enabled: yes