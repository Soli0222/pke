name: Helm Template Diff

on:
  pull_request:
    paths:
      - 'argocd/**/application.yaml'
      - 'argocd/**/values.yaml'

permissions:
  contents: read
  pull-requests: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install --upgrade pip pyyaml

      - name: Render Helm template diff
        id: render
        continue-on-error: true
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          COMMENT_PATH: helm-diff-comment.md
        run: python scripts/render_helm_diff.py

      - name: Upload diff artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: helm-diff-comment
          path: helm-diff-comment.md

      - name: Find existing comment
        if: always()
        id: find-comment
        uses: peter-evans/find-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- helm-diff -->'

      - name: Comment on PR
        if: steps.render.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: helm-diff-comment.md
          token: ${{ secrets.GITHUB_TOKEN }}
          edit-mode: replace
          comment-id: ${{ steps.find-comment.outputs.comment-id }}

      - name: Fail if render failed
        if: steps.render.outcome == 'failure'
        run: exit 1
